<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>ボールヒットゲーム</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.1.9/p5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.1.3/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
      body {
        margin: 0; padding: 0; font-family: sans-serif; overflow: hidden; 
      }
      .ui-container {
        position: absolute; top: 10px; left: 10px; z-index: 10;
        background-color: rgba(0, 0, 0, 0.5); color: white;
        padding: 10px; border-radius: 8px;
      }
      .qr-container {
        position: absolute; top: 10px; right: 10px; z-index: 10;
        padding: 10px; border: 1px solid #ccc; background: #f9f9f9;
        border-radius: 8px;
      }
      #qrcode {
        width:128px; height:128px; margin-top:10px;
      }
      #qr-url {
        font-size: 12px; word-wrap: break-word; width: 128px; color: black;
      }
      .game-info {
        position: absolute; top: 200px; left: 10px; z-index: 10;
      }
      #timer-display {
        color: white; font-size: 2em; margin: 0;
      }
      #result-display {
        color: yellow; font-size: 2.5em; margin: 0; display: none;
      }
    </style>
  </head>

  <body>

    <div class="ui-container">
      <h1>ボールヒットゲーム</h1>
      <div>あなたのID: <span id="myid"></span></div>
      <button id="connect">ルームに入る</button>
      <div>受信した情報はコンソールログで確認してください</div>
    </div>

    <div class="game-info">
      <h2 id="timer-display">Time: 0.0</h2>
      <h2 id="result-display"></h2>
    </div>

    <div class="qr-container">
      <strong>スマホでアクセス</strong>
      <div id="qrcode"></div>
      <div id="qr-url"></div>
    </div>

    <script>
      let socket = io.connect();

      let btn = document.querySelector("#connect");
      let b = 0; 
      let g = 0; 

      
      let myid = sessionStorage.getItem('clientId');
      if (!myid) {
        myid = Math.random().toString(36).substring(2, 15);
        sessionStorage.setItem('clientId', myid);
      }
      document.querySelector("#myid").innerHTML = myid;
      console.log("あなたのID: ", myid);

      btn.addEventListener("click", function () {
        socket.emit("join", "game");
        btn.remove(); 
        document.querySelector(".ui-container").innerHTML = "<h2>ゲームルームに参加しました</h2><p>スマホで操作してください</p>";

        gameStarted = true;
        startTime = millis(); 
      });

      window.addEventListener("load", function() {
        let smartHtmlUrl = `http://${location.hostname}:${location.port}/smart.html`;
        document.querySelector("#qr-url").textContent = smartHtmlUrl;
        new QRCode(document.getElementById("qrcode"), {
            text: smartHtmlUrl, width: 128, height: 128
        });
      });
    
      socket.on("sensor", function (data) {
        if (data.g != null) { g = parseFloat(data.g); }
        if (data.b != null) { b = parseFloat(data.b); }
      });

      let x = 0; 
      let y = 0; 
      let r = 40; 
      let speed = 0.1; 
      
      let targetX, targetY; 
      let targetR = 30;    
      
      let startTime = 0;      
      let elapsedTime = 0;  
      let gameActive = true;  
      let gameStarted = false; 

      function setup() {
        createCanvas(windowWidth, windowHeight, WEBGL);
        camera(0, 800, 300, 0, 0, 0, 0, 1, 0);
        noStroke();

        targetX = random(-(width/2 - 100), (width/2 - 100));
        targetY = random(-(height/2 - 100), (height/2 - 100));
       
      }

      function draw() {
        if (gameStarted && gameActive) { 
          elapsedTime = (millis() - startTime) / 1000.0;
          document.querySelector("#timer-display").innerHTML = "Time: " + elapsedTime.toFixed(1);
        }
        
        if (gameActive) {
          background(0);
        } else {
          background(255, 105, 180); 
        }

        orbitControl(); 
        ambientLight(50, 50, 50);
        directionalLight(100, 20, 20, -1, -1, -1);
        pointLight(20, 20, 100, 0, 0, 800);

        
        push();
        rotateX((-PI * b) / 180);
        rotateY((PI * g) / 180);
        translate(0, 0, -50);
        box(width, height, 30);
        pop();

        
        push();
        let targetZ = -targetX * sin((PI * g) / 180) - targetY * sin((PI * b) / 180);
        translate(targetX, targetY, targetZ);
        specularMaterial(255, 0, 0);
        sphere(targetR);
        pop();

        
        push();
        if (gameActive) {
          x = x + speed * g;
          y = y + speed * b;
        }

        translate(x, y, -x * sin((PI * g) / 180) - y * sin((PI * b) / 180));
        specularMaterial(200); 
        sphere(r);

        if (x > width / 2 - r) x = width / 2 - r;
        if (y > height / 2 - r) y = height / 2 - r;
        if (x < -width / 2 + r) x = -width / 2 + r;
        if (y < -height / 2 + r) y = -height / 2 + r;
        pop();

        // 当たり判定
        let d = dist(x, y, targetX, targetY);
        
        if (gameStarted && gameActive && d < (r + targetR)) {
          gameActive = false; 
          
          let resultTime = elapsedTime.toFixed(1);
          document.querySelector("#result-display").innerHTML = "GOAL! Time: " + resultTime;
          document.querySelector("#result-display").style.display = "block";
          document.querySelector("#timer-display").style.display = "none";
        }
      }

      function windowResized() {
        resizeCanvas(windowWidth, windowHeight);
      }
    </script>
  </body>
</html>